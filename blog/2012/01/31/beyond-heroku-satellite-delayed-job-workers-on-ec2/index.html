
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Beyond Heroku: "Satellite" Delayed Job Workers on EC2 - Artsy Engineering</title>
  <meta name="author" content="">

  
  <meta name="description" content="
  

    



  
    
      
        
          
        
        
          Beyond Heroku: "Satellite" Delayed Job Workers on EC2
        
        ...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:image" content="http://artsy.github.io/images/artsy_oss_image.png" />
  <meta property="og:image:type" content="image/png" />

  
  <link rel="canonical" href="http://artsy.github.io/blog/2012/01/31/beyond-heroku-satellite-delayed-job-workers-on-ec2/">
  <link rel="alternate" type="application/rss+xml" title="Artsy Engineering Blog" href="/feed">

  <link href="/favicon.ico" rel="icon">
  <link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  <script src="/javascripts/jquery-1.11.3.min.js"> </script>
  <script src="/javascripts/gradient-fade.js"></script>
  <script src="/javascripts/noframework.waypoints.min.js"></script>
  <script src="/javascripts/sticky.min.js"></script>
  <script src="/javascripts/search.min.js"></script>

  

  <script type="text/javascript" src="https://fast.fonts.net/jsapi/f7f47a40-b25b-44ee-9f9c-cfdfc8bb2741.js"></script>


  <link href="" rel="alternate" title="Artsy Engineering" type="application/atom+xml">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-12450662-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!--[if IE 8]><link href="/stylesheets/custom/ie_font.css" type="text/css"><![endif]-->

</head>


<body>
  <div id="logo-container">
    <a id="lrg-mark" href="https://www.artsy.net/">
      <svg viewBox="0 0 510 510" width="40" height="40" xmlns="http://www.w3.org/2000/svg">
        <path transform="scale(1, -1) translate(0, -480)" d="M0 -32h512v512h-512v-512v0zM464 16h-80v80h-48v-80h-288v416h416v-416v0zM194 384h-40l-74 -186h38l20 52h72l19 -52h39l-74 186v0zM149 282l25 66l24 -66h-49v0z"/>
      </svg>
    </a>
  </div>
  <header id="banner"><div id="header">
  <div class="header-navigation">
    <ul>
      <li><a href="https://developers.artsy.net/">API</a></li>
      <li><a href="https://www.artsy.net/jobs">Careers</a></li>
      <li><a href="http://twitter.com/artsyopensource">@artsyopensource</a></li>
      <li><a href="http://www.artsy.net/">Artsy.net</a></li>
    </ul>
    <span class="header-section-title">
      
        <a href="/open-source">Open Source</a>
      
    </span>
  </div>

  <div class="header-sticky-container">
    <div class="header-logo">
      <h2><a href="http://artsy.github.io">Artsy</a></h2>
    </div>
    <div class="header-search">
      
        <h2><a href="/">Engineering Blog</a></h2>
        <span>
  <form action="/search" method="get">
    <input class="search" id="search-query" type="text" name="q" results="0" placeholder="Search"/>
  </form>

</span>
      
    </div>
  </div>
</div>
</header>
  <div class="header-hamburger">
    <button class="cmn-toggle-switch cmn-toggle-switch__htx">
      <span>toggle menu</span>
    </button>
  </div>
  <div id="main">
    <div id="content">

      <div>
  <article class="hentry" role="article">

    
<div class="article-container-single ">


  
    <div class="meta-container">
      <header>
        
          <a href="">
        
        
          <h2 class="entry-title">Beyond Heroku: "Satellite" Delayed Job Workers on EC2</h2>
        
          <p class="meta-author">
  



  

  
    <div class="meta">
      <span class="byline author vcard"><a href ="/author/joey">Joey Aghion<a/></span>
      
      <p class="fn">
        <a href="https://twitter.com/joeyAghion">@joeyAghion</a>
      </p>
      

    </div>
  

</p>
          </a>
      </header>
    </div>
  

  <div class="content-container">
    
      <div class="entry-content"><p>[TL;DR: To supplement Heroku-managed app servers, we launched custom EC2 instances to host Delayed Job worker processes. See the <a href="https://github.com/joeyAghion/satellite_setup">satellite_setup github repo</a> for rake tasks and Chef recipes that make it easy.]</p>

<p><a href="http://artsy.net">Artsy</a> engineers are big users and abusers of <a href="http://heroku.com">Heroku</a>. It's a neat abstraction of server resources, so we were conflicted when parts of our application started to bump into Heroku's limitations. While we weren't eager to start managing additional infrastructure, we found that--with a few good tools--we could migrate some components away from Heroku without fragmenting the codebase or over-complicating our development environments.</p>

<p>There are a number of reasons your app might need to go beyond Heroku. It might rely on a locally installed tool (not possible on Heroku's locked-down servers), or require heavy file-system usage (limited to <code>tmp/</code> and <code>log/</code>, and not permanent or shared). In our case, the culprit was Heroku's 512 MB RAM limit--reasonable for most web processes, but quickly exceeded by the image-processing tasks of our <a href="https://github.com/collectiveidea/delayed_job">delayed_job</a> workers. We considered building a specialized image-processing service, but decided instead to supplement our web apps with a custom <a href="http://aws.amazon.com/ec2/">EC2</a> instance dedicated to processing background tasks. We call these servers "satellites."</p>

<p>We'll walk through the pertinent sections here, but you can find Rake tasks that correspond with these scripts, plus all of the necessary cookbooks, in the <a href="https://github.com/joeyAghion/satellite_setup">satellite_setup github repo</a>. Now, on to the code!</p>

<p>First, generate a key-pair from <a href="https://console.aws.amazon.com/ec2/home?#s=KeyPairs">Amazon's AWS Management Console</a>. Then we'll use <a href="http://fog.io">Fog</a> to spawn the EC2 instance.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;fog&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Update these values according to your environment...</span>
</span><span class='line'><span class="no">S3_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="s1">&#39;XXXXXXXXXXXXXXXXXXXX&#39;</span>
</span><span class='line'><span class="no">S3_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="s1">&#39;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#39;</span>
</span><span class='line'><span class="no">KEY_NAME</span> <span class="o">=</span> <span class="s1">&#39;satellite_keypair&#39;</span>
</span><span class='line'><span class="no">KEY_PATH</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOME&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/.ssh/</span><span class="si">#{</span><span class="no">KEY_NAME</span><span class="si">}</span><span class="s2">.pem&quot;</span>
</span><span class='line'><span class="no">IMAGE_ID</span> <span class="o">=</span> <span class="s1">&#39;ami-c162a9a8&#39;</span>  <span class="c1"># 64-bit Ubuntu 11.10</span>
</span><span class='line'><span class="no">FLAVOR_ID</span> <span class="o">=</span> <span class="s1">&#39;m1.large&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">connection</span> <span class="o">=</span> <span class="no">Fog</span><span class="o">::</span><span class="no">Compute</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">provider</span><span class="p">:</span> <span class="s1">&#39;AWS&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">aws_access_key_id</span><span class="p">:</span> <span class="no">S3_ACCESS_KEY_ID</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">aws_secret_access_key</span><span class="p">:</span> <span class="no">S3_SECRET_ACCESS_KEY</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">server</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">bootstrap</span><span class="p">(</span>
</span><span class='line'>  <span class="ss">key_name</span><span class="p">:</span> <span class="no">KEY_NAME</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">private_key_path</span><span class="p">:</span> <span class="no">KEY_PATH</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">image_id</span><span class="p">:</span> <span class="no">IMAGE_ID</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">flavor_id</span><span class="p">:</span> <span class="no">FLAVOR_ID</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we'll do some basic server prep and install our preferred Ruby version.<!-- more --> We'll again use Fog, this time to SSH into the new instance and run the following commands:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span> <span class="sx">%{sudo sh -c &quot;grep &#39;^[^#].*us-east-1\.ec2&#39; /etc/apt/sources.list | sed &#39;s/us-east-1\.ec2/us/g&#39; &gt; /etc/apt/sources.list.d/better.list&quot;}</span><span class="p">,</span>
</span><span class='line'>  <span class="sx">%{sudo apt-get update; sudo apt-get install -y make gcc rsync curl zlib1g-dev libssl-dev libreadline-dev libreadline5}</span><span class="p">,</span>
</span><span class='line'>  <span class="sx">%{mkdir -p /tmp/bootstrap}</span><span class="p">,</span>
</span><span class='line'>  <span class="sx">%{cd /tmp/bootstrap &amp;&amp; curl -L &#39;ftp://ftp.ruby-lang.org/pub/ruby/1.9/ruby-1.9.2-p290.tar.gz&#39; | tar xvzf - &amp;&amp; cd ruby-1.9.2-p290 &amp;&amp; ./configure &amp;&amp; make &amp;&amp; sudo make install}</span><span class="p">,</span>
</span><span class='line'>  <span class="sx">%{cd /tmp/bootstrap &amp;&amp; curl -L &#39;http://production.cf.rubygems.org/rubygems/rubygems-1.6.2.tgz&#39; | tar xvzf - &amp;&amp; cd rubygems* &amp;&amp; sudo ruby setup.rb --no-ri --no-rdoc}</span><span class="p">,</span>
</span><span class='line'>  <span class="sx">%{sudo gem install rdoc chef ohai --no-ri --no-rdoc --source http://gems.rubyforge.org}</span>
</span><span class='line'><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">command</span><span class="o">|</span>
</span><span class='line'>  <span class="n">server</span><span class="o">.</span><span class="n">ssh</span> <span class="n">command</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first command replaces some broken links in the AMI's <code>/etc/apt/sources.list</code>, so that the later package installation commands have a chance. We then install a few necessary packages, download and install Ruby 1.9.2 from source, and install RubyGems. Finally, we install <a href="http://www.opscode.com/chef/">Chef</a> so we can let <code>chef-solo</code> drive the remainder of the configuration (and manage it going forward).</p>

<p>Chef deserves a few blog posts of its own, but know that it provides a platform-independent DSL for specifying an environment's configuration. <a href="http://www.opscode.com">Opscode</a> supplies a deep set of related tools, but for our purposes, <code>chef-solo</code>--which applies a local set of configuration "cookbooks" to an individual server--will be plenty. These lines copy our local cookbooks folder (originally in <code>config/satellite</code>) up to a temporary location on the server, then execute the <code>chef-solo</code> command via SSH:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">system</span> <span class="s2">&quot;rsync -rlP --rsh=</span><span class="se">\&quot;</span><span class="s2">ssh -i </span><span class="si">#{</span><span class="no">KEY_PATH</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> --delete --exclude &#39;.*&#39; ./config/satellite ubuntu@</span><span class="si">#{</span><span class="n">server</span><span class="o">.</span><span class="n">dns_name</span><span class="si">}</span><span class="s2">:/tmp/chef/&quot;</span>
</span><span class='line'><span class="n">server</span><span class="o">.</span><span class="n">ssh</span> <span class="s2">&quot;cd /tmp/chef/satellite; RAILS_ENV=staging sudo -H -E chef-solo -c solo.rb -j configure.json -l info&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first file referenced in that command simply declares where cookbooks will be found. In our case, they're stored alongside <code>solo.rb</code> in the temporary directory.</p>

<figure class='code'><figcaption><span>config/satellite/solo.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">cookbook_path</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">),</span> <span class="s2">&quot;cookbooks&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next file, <code>configure.json</code>, specifies that Chef should apply the <code>configure</code> recipe found in the <code>example_app</code> cookbook.</p>

<figure class='code'><figcaption><span>config/satellite/configure.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span><span class="s2">&quot;recipes&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;example_app::configure&quot;</span><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, let's look at the <code>example_app::configure</code> recipe. First it will make sure necessary packages and gems are installed. These, of course, might be different for your app.</p>

<figure class='code'><figcaption><span>config/satellite/cookbooks/example_app/recipes/configure.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span> <span class="s1">&#39;build-essential&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;binutils-doc&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;autoconf&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;flex&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;bison&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;openssl&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;libreadline5&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;libreadline-dev&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;git-core&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;zlib1g&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;zlib1g-dev&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;libssl-dev&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;libxml2-dev&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;autoconf&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;libxslt-dev&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;imagemagick&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;libmagick9-dev&#39;</span>
</span><span class='line'><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pkg</span><span class="o">|</span>
</span><span class='line'>  <span class="n">package</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">gem_package</span> <span class="s1">&#39;bundler&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">version</span> <span class="s1">&#39;1.0.10&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, it will ensure that a user and group (named for <code>example_app</code>) are created and configured:</p>

<figure class='code'><figcaption><span>config/satellite/cookbooks/example_app/recipes/configure.rb (cont'd)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="s1">&#39;example_app&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">user</span> <span class="s1">&#39;example_app&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gid</span> <span class="s1">&#39;example_app&#39;</span>
</span><span class='line'>  <span class="n">home</span> <span class="s1">&#39;/home/example_app&#39;</span>
</span><span class='line'>  <span class="n">shell</span> <span class="s1">&#39;/bin/bash&#39;</span>
</span><span class='line'>  <span class="n">supports</span> <span class="ss">:manage_home</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">directory</span> <span class="s1">&#39;/home/example_app/.ssh&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">owner</span> <span class="s1">&#39;example_app&#39;</span>
</span><span class='line'>  <span class="n">group</span> <span class="s1">&#39;example_app&#39;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0700</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Ensure example_app can sudo</span>
</span><span class='line'><span class="n">cookbook_file</span> <span class="s1">&#39;/etc/sudoers.d/example_app&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0440</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span> <span class="s1">&#39;authorized_keys&#39;</span><span class="p">,</span>  <span class="c1"># place the keys you want to authorize for SSH in this file</span>
</span><span class='line'>  <span class="s1">&#39;id_dsa&#39;</span><span class="p">,</span>  <span class="c1"># a new private key file, authorized to pull from your git repo</span>
</span><span class='line'>   <span class="s1">&#39;config&#39;</span>  <span class="c1"># avoid prompt when pulling from github</span>
</span><span class='line'><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">config_file</span><span class="o">|</span>
</span><span class='line'>  <span class="n">cookbook_file</span> <span class="s2">&quot;/home/example_app/.ssh/</span><span class="si">#{</span><span class="n">config_file</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">owner</span> <span class="s1">&#39;example_app&#39;</span>
</span><span class='line'>    <span class="n">group</span> <span class="s1">&#39;example_app&#39;</span>
</span><span class='line'>    <span class="n">mode</span> <span class="mo">0600</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Allow other developers to SSH as primary ubuntu account as well.</span>
</span><span class='line'><span class="n">cookbook_file</span> <span class="s2">&quot;/home/ubuntu/.ssh/authorized_keys&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">owner</span> <span class="s1">&#39;ubuntu&#39;</span>
</span><span class='line'>  <span class="n">group</span> <span class="s1">&#39;ubuntu&#39;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0600</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, it creates supporting directories.</p>

<figure class='code'><figcaption><span>config/satellite/cookbooks/example_app/recipes/configure.rb (cont'd)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span> <span class="s1">&#39;/app&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;/app/example_app&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;/app/example_app/shared&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;/app/example_app/shared/log&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;/app/example_app/shared/pids&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;/app/example_app/shared/config&#39;</span>
</span><span class='line'><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
</span><span class='line'>  <span class="n">directory</span> <span class="n">dir</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">owner</span> <span class="s1">&#39;example_app&#39;</span>
</span><span class='line'>    <span class="n">group</span> <span class="s1">&#39;example_app&#39;</span>
</span><span class='line'>    <span class="n">mode</span> <span class="mo">0755</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We rely heavily on the <a href="http://newrelic.com/">New Relic</a> plug-in, and want to enable it in our custom environment as well. Heroku usually takes care of injecting a <code>newrelic.yml</code> configuration file into our app servers, so we'll have to replicate that in our custom environment. Depending on what plug-ins you've enabled (e.g., <a href="http://sendgrid.com">Sendgrid</a>), you might need to replicate other configuration files or initializers.</p>

<figure class='code'><figcaption><span>config/satellite/cookbooks/example_app/recipes/configure.rb (cont'd)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">cookbook_file</span> <span class="s2">&quot;/app/example_app/shared/config/newrelic.yml&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">owner</span> <span class="s1">&#39;example_app&#39;</span>
</span><span class='line'>  <span class="n">group</span> <span class="s1">&#39;example_app&#39;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0755</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://mmonit.com/monit/">Monit</a> is a great tool for starting, managing, and monitoring long-running processes. It can be configured with all sorts of thresholds and alerting. (We've included only a simple configuration in the <a href="https://github.com/joeyAghion/satellite_setup">github repo</a> for now.) Let's include the <code>monit</code> recipe, to ensure that monit is installed and running, and then add the necessary configuration for monit to start and monitor our delayed_job worker process.</p>

<figure class='code'><figcaption><span>config/satellite/cookbooks/example_app/recipes/configure.rb (cont'd)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;monit&#39;</span>
</span><span class='line'><span class="n">monitrc</span> <span class="s1">&#39;delayed_job&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="ss">:immediately</span>
</span></code></pre></td></tr></table></div></figure>


<p>To keep disk space from becoming a problem, we'll automatically rotate all of the logs in our app's shared <code>log/</code> directory.</p>

<figure class='code'><figcaption><span>config/satellite/cookbooks/example_app/recipes/configure.rb (cont'd)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">logrotate_app</span> <span class="s2">&quot;example_app&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">path</span> <span class="s2">&quot;/app/example_app/shared/log/*.log&quot;</span>
</span><span class='line'>  <span class="n">frequency</span> <span class="s2">&quot;daily&quot;</span>
</span><span class='line'>  <span class="n">rotate</span> <span class="mi">30</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;example_app::deploy&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That last line loads up the neighboring <code>deploy.rb</code> recipe, which is responsible for checking out the appropriate version of the codebase to the server and [re]starting the delayed_job worker:</p>

<figure class='code'><figcaption><span>config/satellite/cookbooks/example_app/deploy.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">deploy</span> <span class="s2">&quot;/app/example_app&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">repo</span> <span class="s2">&quot;git@github.com:my_org/example_app.git&quot;</span>  <span class="c1"># update this!</span>
</span><span class='line'>  <span class="n">branch</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;rails_env&#39;</span><span class="o">]</span>  <span class="c1"># assumes a branch named for this RAILS_ENV (e.g., staging, production)</span>
</span><span class='line'>  <span class="n">shallow_clone</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">environment</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;rails_env&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">symlinks</span> <span class="s1">&#39;pids&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;tmp/pids&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;config/newrelic.yml&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;config/newrelic.yml&#39;</span>
</span><span class='line'>  <span class="n">before_restart</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">current_release</span> <span class="o">=</span> <span class="n">release_path</span>
</span><span class='line'>    <span class="n">execute</span><span class="p">(</span><span class="s2">&quot;bundle install --without development test&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">cwd</span> <span class="n">current_release</span>
</span><span class='line'>      <span class="n">user</span> <span class="s1">&#39;example_app&#39;</span>
</span><span class='line'>      <span class="n">group</span> <span class="s1">&#39;example_app&#39;</span>
</span><span class='line'>      <span class="n">environment</span> <span class="s1">&#39;HOME&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/home/example_app&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">restart_command</span> <span class="p">{</span> <span class="n">execute</span> <span class="s2">&quot;monit restart delayed_job&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">user</span> <span class="s1">&#39;example_app&#39;</span>
</span><span class='line'>  <span class="n">group</span> <span class="s1">&#39;example_app&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>deploy</code> Chef command creates a new timestamped directory under <code>/app/example_app/releases</code> and cleans up any older release directories, leaving the most recent 5 (much in the style of <a href="https://github.com/capistrano/capistrano">Capistrano</a>). It also symlinks necessary directories and files and restarts the delayed_job worker.</p>

<p>Did you notice how we ensure that Heroku and the satellite use the same version of the codebase? We've formalized <code>staging</code> and <code>production</code> branches and update them with the commits we intend to deploy. Of course, we can't simply <code>git push heroku master</code> anymore. Instead, we push to the appropriate branch, then push that to heroku and re-run the satellite's <code>deploy</code> recipe. Here, we've wrapped the process up into a single <code>deploy:[staging|production]</code> rake task. (The precise branches might vary depending on your development workflow.)</p>

<figure class='code'><figcaption><span>lib/tasks/deploy.rake</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s1">&#39;Merge master into a staging branch and deploy it to example_app-staging.&#39;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:staging</span> <span class="o">=&gt;</span> <span class="s1">&#39;git:tag:staging&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="sb">`git push git@heroku.com:example_app-staging.git origin/staging:master`</span>
</span><span class='line'>    <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RAILS_ENV&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;staging&#39;</span>
</span><span class='line'>    <span class="n">task</span><span class="p">(</span><span class="s1">&#39;satellite:deploy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">invoke</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s1">&#39;Merge staging into a production branch and deploy it to example_app-production.&#39;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:production</span> <span class="o">=&gt;</span> <span class="s1">&#39;git:tag:production&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="sb">`git push git@heroku.com:example_app-production.git origin/production:master`</span>
</span><span class='line'>    <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RAILS_ENV&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;production&#39;</span>
</span><span class='line'>    <span class="n">task</span><span class="p">(</span><span class="s1">&#39;satellite:deploy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">invoke</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:git</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:tag</span><span class="p">,</span> <span class="o">[</span><span class="ss">:from</span><span class="p">,</span> <span class="ss">:to</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="ss">:confirm_clean</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="o">|</span>
</span><span class='line'>    <span class="k">raise</span> <span class="s2">&quot;Must specify &#39;from&#39; and &#39;to&#39; branches&quot;</span> <span class="k">unless</span> <span class="n">args</span><span class="o">[</span><span class="ss">:from</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="n">args</span><span class="o">[</span><span class="ss">:to</span><span class="o">]</span>
</span><span class='line'>    <span class="sb">`git fetch`</span>
</span><span class='line'>    <span class="sb">`git branch -f </span><span class="si">#{</span><span class="n">args</span><span class="o">[</span><span class="ss">:to</span><span class="o">]</span><span class="si">}</span><span class="sb"> origin/</span><span class="si">#{</span><span class="n">args</span><span class="o">[</span><span class="ss">:to</span><span class="o">]</span><span class="si">}</span><span class="sb">`</span>
</span><span class='line'>    <span class="sb">`git checkout </span><span class="si">#{</span><span class="n">args</span><span class="o">[</span><span class="ss">:to</span><span class="o">]</span><span class="si">}</span><span class="sb">`</span>
</span><span class='line'>    <span class="sb">`git reset --hard origin/</span><span class="si">#{</span><span class="n">args</span><span class="o">[</span><span class="ss">:from</span><span class="o">]</span><span class="si">}</span><span class="sb">`</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Updating </span><span class="si">#{</span><span class="n">args</span><span class="o">[</span><span class="ss">:to</span><span class="o">]</span><span class="si">}</span><span class="s2"> with these commits:&quot;</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="sb">`git log origin/</span><span class="si">#{</span><span class="n">args</span><span class="o">[</span><span class="ss">:to</span><span class="o">]</span><span class="si">}</span><span class="sb">..</span><span class="si">#{</span><span class="n">args</span><span class="o">[</span><span class="ss">:to</span><span class="o">]</span><span class="si">}</span><span class="sb"> --format=format:&quot;%h  %s  (%an)&quot;`</span>
</span><span class='line'>    <span class="sb">`git push -f origin </span><span class="si">#{</span><span class="n">args</span><span class="o">[</span><span class="ss">:to</span><span class="o">]</span><span class="si">}</span><span class="sb">`</span>
</span><span class='line'>    <span class="sb">`git checkout master`</span>
</span><span class='line'>    <span class="sb">`git branch -D </span><span class="si">#{</span><span class="n">args</span><span class="o">[</span><span class="ss">:to</span><span class="o">]</span><span class="si">}</span><span class="sb">`</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:confirm_clean</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">raise</span> <span class="s2">&quot;Must have clean working directory&quot;</span> <span class="k">unless</span> <span class="sb">`git status`</span> <span class="o">=~</span> <span class="sr">/working directory clean/</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">namespace</span> <span class="ss">:tag</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">task</span> <span class="ss">:staging</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">task</span><span class="p">(</span><span class="s1">&#39;git:tag&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s1">&#39;master&#39;</span><span class="p">,</span>  <span class="s1">&#39;staging&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">task</span> <span class="ss">:production</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">task</span><span class="p">(</span><span class="s1">&#39;git:tag&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s1">&#39;staging&#39;</span><span class="p">,</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our satellite requires access to some of the same environment variables as our Heroku web apps (such as a database host or mail server credentials). To keep these synchronized, we rely on a <code>config/heroku.yml</code> file. (This duplication is an obvious hazard and deserves improvement, but we've actually found it convenient to have these locally for easy access from Rake tasks, etc.)</p>

<p>In the <a href="https://github.com/joeyAghion/satellite_setup">satellite_setup</a> github repo, we've simplified this set-up into a few tasks that we use on an ongoing basis:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rake satellite:spawn <span class="nv">RAILS_ENV</span><span class="o">=</span>staging
</span><span class='line'><span class="nv">$ </span>rake satellite:configure <span class="nv">RAILS_ENV</span><span class="o">=</span>staging
</span><span class='line'><span class="nv">$ </span>rake satellite:info <span class="nv">RAILS_ENV</span><span class="o">=</span>staging
</span><span class='line'>  <span class="m">1</span> satellite server<span class="o">(</span>s<span class="o">)</span>
</span><span class='line'>      state: running <span class="o">(</span>1<span class="o">)</span>
</span><span class='line'>          i-f4583196  staging ec2-170-179-113-159.compute-1.amazonaws.com 2012-01-03 14:48:11 UTC
</span><span class='line'><span class="nv">$ </span>rake satellite:deploy <span class="nv">RAILS_ENV</span><span class="o">=</span>staging
</span><span class='line'><span class="nv">$ </span>rake satellite:destroy <span class="nv">RAILS_ENV</span><span class="o">=</span>staging
</span></code></pre></td></tr></table></div></figure>


<p>This arrangement has worked for us so far. Satellite servers cost a little more, but can benefit from arbitrary customization and are served out of the same data-centers as our Heroku-based web apps and S3 storage. Since the same app is running transparently in 2 different environments, our developers' workflow has hardly needed modification. In fact, the portability enforced by Heroku's design (elaborated in <a href="http://12factor.net">The Twelve-Factor App</a>) made this transition relatively straightforward.</p>

<p>Some worthy enhancements might be:</p>

<ul>
<li>Improving monitoring and notifications</li>
<li>Extending the recipes to manage multiple parallel workers</li>
<li>Using Chef attributes to replace uses of <code>example_app</code> with a parameter</li>
<li>Cleaning up the duplication of Heroku configuration values in <code>heroku.yml</code></li>
</ul>

</div>
    

    
      <p class="meta-author">
        
  





<div class="meta">
  Posted by


  

  
    <span class="byline author vcard">

      <div class="meta"><span class="fn"><a href="/author/joey">
        Joey Aghion
      </a></span></div>

      
      <span class="fn">
        <a href="http://joey.aghion.com">Site</a>
      </span>
      
      
      <span class="fn">
        <a href="https://github.com/joeyAghion">GitHub</a>
      </span>
      
      
      <span class="fn">
        <a href="https://twitter.com/joeyAghion">@joeyAghion</a>
      </span>
      
    </span>

  
</div>




      </p>
      <p class="meta-categories">
        Categories: 

<span class="categories">
  
    <a class='category' href='/blog/categories/chef/'>chef</a>, <a class='category' href='/blog/categories/ec2/'>ec2</a>, <a class='category' href='/blog/categories/fog/'>fog</a>, <a class='category' href='/blog/categories/heroku/'>heroku</a>
  
</span>


      </p>
      

      
        <hr/>
        <section class="comments">
          <h1>Comments</h1>
          <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        </section>
        <hr/>
      

      <p class="meta-paginate">
        
          <a class="previous" href="/blog/2012/01/31/delaying-carrierwave-image-processing/" title="Previous Post: Delaying CarrierWave Image Processing">&laquo; Delaying CarrierWave Image Processing</a>
        
        
          <a class="next" href="/blog/2012/02/03/reliably-testing-asynchronous-ui-w-slash-rspec-and-capybara/" title="next Post: Reliably Testing Asynchronous UI w/ RSpec and Capybara">Reliably Testing Asynchronous UI w/ RSpec and Capybara &raquo;</a>
        
      </p>
    
  </div>


  <footer>
  </footer>

</div>


  </article>
</div>


    </div>
  </div>
  <footer id="main_footer"> <div class="footer-navigation">
  <ul>
    <li><a href="https://developers.artsy.net/">API</a></li>
    <li><a href="https://www.artsy.net/jobs">Careers</a></li>
    <li><a href="http://twitter.com/artsyopensource">@artsyopensource</a></li>
    <li><a href="http://www.artsy.net/">Artsy.net</a></li>
  </ul>
</div>



<script type="text/javascript">
      var disqus_shortname = 'artsy';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://artsy.github.io/blog/2012/01/31/beyond-heroku-satellite-delayed-job-workers-on-ec2/';
        var disqus_url = 'http://artsy.github.io/blog/2012/01/31/beyond-heroku-satellite-delayed-job-workers-on-ec2/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


</footer>
  <script type="text/javascript">
  $(function() {
    // TODO: Move this whole file to a javascript file that is included in the footer

    // Main sticky header
    if ($(window).width() >= 700) {
      var sticky = new Waypoint.Sticky({
        element: $("#banner"),
        offset: -100
      });
    }

    // Toggle hamburger menu
    $('.header-hamburger').click(function() {
      $('#banner, .cmn-toggle-switch').toggleClass('active');
      if (location.pathname == '/open-source') {
        $('.header-search span').hide();
        $('#page-sidebar').toggle();
      }
    });

    // Toggle search focus on mobile
    $('input.search').focus(function() {
      $('#header').addClass('search-focused');
    }).blur(function() {
      $('#header').removeClass('search-focused');
    });
  });
</script>

</body>
</html>
